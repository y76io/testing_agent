{% extends 'layout.html' %}
{% block content %}
  <h2 style="margin-top:0;">Evaluation Sections — {{ standard_name }}</h2>
  <p style="color:var(--muted);">Sections grouped by evaluation type (Interview, API evals, Document analysis), with access as secondary.</p>
  <div style="display:grid; grid-template-columns: 1fr; gap: 14px;">
    {% for g in groups %}
    <div class="card">
      <h3 style="margin:0 0 10px;">{{ g.evaluation_type }}</h3>
      <div style="display:grid; grid-template-columns: 1fr; gap: 10px;">
        {% for ag in g.access_groups %}
        <div class="card-inner">
          <div style="font-weight:600; margin-bottom:6px;">{{ ag.access }}</div>
          <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:10px;">
            {% for it in ag['items'] %}
              <div class="card-inner" style="background:#0b1a2b;">
                <div style="font-weight:600;">{{ it.id }} — {{ it.name }}</div>
                {% if it.evals and it.evals|length > 0 %}
                  <div style="margin-top:8px; display:grid; grid-template-columns: 1fr; gap:8px;">
                    {% for ln in it.evals %}
                      <div class="card-inner" style="background:#0d2338;">
                        {% set mid = ln.eval_id or ln.id %}
                        {% set st = (status_map[mid] if status_map and mid in status_map else 'not_tried') %}
                        {% set color = '#3b82f6' %}
                        {% if st == 'passed' %}{% set color = '#10b981' %}{% elif st == 'failed' %}{% set color = '#ef4444' %}{% elif st == 'in_progress' %}{% set color = '#f59e0b' %}{% endif %}
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                          <div style="font-weight:500;">{{ ln.title or mid }}</div>
                          <span style="font-size:12px; color: {{ color }}; border:1px solid {{ color }}; padding:2px 6px; border-radius: 999px; text-transform: capitalize;">{{ st.replace('_',' ') }}</span>
                        </div>
                        <div style="margin-top:6px;">
                          <a class="btn" href="/ui/eval?eval_id={{ eval_id }}&item_id={{ it.id }}&metric_id={{ mid }}">Open {{ g.evaluation_type }}</a>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div style="margin-top:8px;">
                    <a class="btn secondary" href="/ui/choose_metric?eval_id={{ eval_id }}&item_id={{ it.id }}">Choose metric</a>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% else %}
      <p>No sections selected.</p>
    {% endfor %}
  </div>
  {% if eval_id %}
  <div style="margin-top: 12px; text-align:right;">
    <a class="btn secondary" href="/ui/plan?eval_id={{ eval_id }}">Main evaluation</a>
  </div>
  {% endif %}
{% endblock %}
