{% extends 'layout.html' %}
{% block content %}
  <h2 style="margin-top:0;">API Connectivity Test</h2>
  <p style="color:var(--muted); margin-top:.25rem;">We tried a single message to learn the API shape. Confirm the extracted message looks correct before continuing.</p>

  {% if artifacts and artifacts|length > 0 %}
    {% set a = artifacts[0] %}
    <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
      <span><strong>System:</strong> {{ system_id }}</span>
      <span><strong>Run:</strong> <a href="/ui/run/{{ run_id }}">{{ run_id }}</a></span>
      <span><strong>Status:</strong> {{ a.response.status }}</span>
      <span><strong>Latency:</strong> {{ a.latency_ms }} ms</span>
      <span><strong>Error:</strong> {{ a.error_detected }}</span>
    </div>

    {% if analysis and analysis.is_error %}
      <div class="error" style="margin: 8px 0 12px;">The response appears to be an error.</div>
      {% if analysis.reasons and analysis.reasons|length %}
        <h4>Reasons</h4>
        <ul>
          {% for r in analysis.reasons %}<li>{{ r }}</li>{% endfor %}
        </ul>
      {% endif %}
      {% if analysis.advice and analysis.advice|length %}
        <h4>Advice</h4>
        <ul>
          {% for r in analysis.advice %}<li>{{ r }}</li>{% endfor %}
        </ul>
      {% endif %}
      {% if analysis.clarification %}
        <div class="card-inner" style="margin-top:8px;">
          <strong>LLM clarification</strong>
          <p style="margin:.25rem 0 0;">{{ analysis.clarification }}</p>
        </div>
      {% endif %}
    {% else %}
      <!-- 1) Request (hidable) -->
      <details class="expander" style="margin-top:8px;">
        <summary>Request preview <span class="chev">▶</span></summary>
        <div class="content"><pre class="code">{{ a.request | tojson(indent=2) }}</pre></div>
      </details>

      <!-- 2) Response (hidable) -->
      <details class="expander" style="margin-top:8px;" open>
        <summary>Response preview <span class="chev">▶</span></summary>
        <div class="content"><pre class="code">{{ a.response.body | tojson(indent=2) }}</pre></div>
      </details>

      <!-- 3) Extractor (single place, editable, with Test/Save and Extracted message) -->
      <details class="expander" style="margin-top:8px;" open>
        <summary>Extractor function <span class="chev">▶</span></summary>
        <div class="content">
          <form method="post" id="extractor-form">
            <input type="hidden" name="system_id" value="{{ system_id }}" />
            <input type="hidden" name="run_id" value="{{ run_id }}" />
            {% if eval_id %}<input type="hidden" name="eval_id" value="{{ eval_id }}" />{% endif %}
            {% if item_id %}<input type="hidden" name="item_id" value="{{ item_id }}" />{% endif %}
            {% if metric_id %}<input type="hidden" name="metric_id" value="{{ metric_id }}" />{% endif %}
            <label>Extractor code (Python)</label>
            <textarea name="extractor_code" rows="10">{{ mapping.message_extractor or 'def extract_message(resp):\n    return ""' }}</textarea>
            <div style="display:flex; gap:8px; margin-top:.5rem;">
              <button class="btn secondary" type="button" id="btn-test-extractor">Test</button>
              <button class="btn" type="submit" formaction="/ui/save_extractor" formmethod="post">Save</button>
            </div>
            <div style="margin-top:10px;">
              <div style="font-weight:600;">Extracted message</div>
              <pre id="extracted-message" class="code" style="white-space:pre-wrap;">{{ extracted_preview or a.response.message_extracted or '' }}</pre>
              <div id="extractor-error" style="color: var(--danger); margin-top:.25rem; display:none;"></div>
            </div>
          </form>
        </div>
      </details>

    {% endif %}

    <details class="expander" style="margin-top:8px;">
      <summary>Request preview <span class="chev">▶</span></summary>
      <div class="content"><pre class="code">{{ a.request | tojson(indent=2) }}</pre></div>
    </details>
  {% else %}
    <p>No artifacts were captured. Please verify the endpoint and try again.</p>
  {% endif %}

  <h3>Detected Mapping</h3>
  <details class="expander" open>
    <summary>Mapping details <span class="chev">▶</span></summary>
    <div class="content">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div>
          <h4>Prompt Paths</h4>
          <pre class="code">{{ mapping.prompt_paths | tojson(indent=2) }}</pre>
        </div>
        <div>
          <h4>Response Paths</h4>
          <pre class="code">{{ mapping.response_paths | tojson(indent=2) }}</pre>
        </div>
      </div>
      <h4>Error Rules</h4>
      <pre class="code">{{ mapping.error_rules | tojson(indent=2) }}</pre>
    </div>
  </details>

  <form method="get" action="/ui/configure" style="margin-top:1rem; display:inline-block;">
    <input type="hidden" name="system_id" value="{{ system_id }}"/>
    {% if eval_id %}<input type="hidden" name="eval_id" value="{{ eval_id }}" />{% endif %}
    {% if item_id %}<input type="hidden" name="item_id" value="{{ item_id }}" />{% endif %}
    {% if metric_id %}<input type="hidden" name="metric_id" value="{{ metric_id }}" />{% endif %}
    <button class="btn" type="submit">Confirm API</button>
  </form>
  {% if eval_id and item_id %}
  <form method="post" action="/ui/api/run_dataset" style="margin-top:1rem; display:inline-block; margin-left:8px;">
    <input type="hidden" name="system_id" value="{{ system_id }}" />
    <input type="hidden" name="eval_id" value="{{ eval_id }}" />
    <input type="hidden" name="item_id" value="{{ item_id }}" />
    <button class="btn secondary" type="submit">Run dataset for this item</button>
  </form>
  {% if metric_id %}
  <form method="get" action="/ui/metric_runner" style="margin-top:1rem; display:inline-block; margin-left:8px;">
    <input type="hidden" name="system_id" value="{{ system_id }}" />
    <input type="hidden" name="eval_id" value="{{ eval_id }}" />
    <input type="hidden" name="item_id" value="{{ item_id }}" />
    <input type="hidden" name="metric_id" value="{{ metric_id }}" />
    <button class="btn" type="submit">Run full evaluation for this metric</button>
  </form>
  {% endif %}
  {% endif %}
  {% if analysis and analysis.is_error %}
  <details class="expander" style="margin-top: 1rem;">
    <summary>Adjust and Re-run <span class="chev">▶</span></summary>
    <div class="content">
    <form method="post" action="/ui/new{% if eval_id %}?eval_id={{ eval_id }}{% endif %}" onsubmit="showLoading()" style="margin-top:.75rem;">
      <input type="hidden" name="system_id" value="{{ prev.system_id }}" />
      <label>Name</label>
      <input name="name" value="{{ prev.name }}" />
      <label>Endpoint URL</label>
      <input name="endpoint" value="{{ prev.endpoint }}" />
      <label>HTTP Method</label>
      <select name="method">
        <option {% if prev.method=='POST' %}selected{% endif %}>POST</option>
        <option {% if prev.method=='GET' %}selected{% endif %}>GET</option>
      </select>
      <label>Headers JSON</label>
      <textarea name="headers_json" rows="6">{{ prev.headers_json }}</textarea>
      <label>Request Body JSON</label>
      <textarea name="body_json" rows="12">{{ prev.body_json }}</textarea>
      <label>Test Prompt</label>
      <input name="test_prompt" value="{{ prev.test_prompt }}" />
      <div style="display:flex; gap: 16px; align-items:center; flex-wrap:wrap; margin-top: 1rem;">
        <label style="display:flex; align-items:center; gap:6px; margin-top:0;">
          <input type="checkbox" name="add_api_key" value="1" {% if prev.add_api_key %}checked{% endif %} />
          Add API key header
        </label>
        <input name="api_key_name" value="{{ prev.api_key_name }}" placeholder="Header name" style="max-width:260px;">
        <input name="api_key_value" value="{{ prev.api_key_value }}" placeholder="Key value" style="max-width:320px;">
      </div>
      <div style="display:flex; gap: 16px; align-items:center; flex-wrap:wrap; margin-top: .5rem;">
        <label style="display:flex; align-items:center; gap:6px; margin-top:0;">
          <input type="checkbox" name="add_session_id" value="1" {% if prev.add_session_id %}checked{% endif %} />
          Add session_id to body
        </label>
        <input name="session_id_field" value="{{ prev.session_id_field }}" style="max-width:240px;">
      </div>
      <div style="margin-top: .75rem;">
        <button class="btn" type="submit">Run Again</button>
      </div>
    </form>
    </div>
  </details>
  {% endif %}
  {% if eval_id %}
  <div style="margin-top:12px; text-align:right;">
    <a class="btn secondary" href="/ui/plan?eval_id={{ eval_id }}">Main evaluation</a>
  </div>
  {% endif %}
  <script>
    (function(){
      const form = document.getElementById('extractor-form');
      const btn = document.getElementById('btn-test-extractor');
      const out = document.getElementById('extracted-message');
      const err = document.getElementById('extractor-error');
      if (btn) {
        btn.addEventListener('click', async function(){
          const fd = new FormData(form);
          fd.append('_ts', String(Date.now()));
          try {
            const res = await fetch('/ui/apply_extractor_json', {
              method: 'POST',
              body: fd,
              cache: 'no-store',
              headers: { 'Accept': 'application/json' }
            });
            const data = await res.json();
            if (data.ok) {
              if (err) { err.style.display = 'none'; err.textContent=''; }
              if (out) { out.textContent = data.extracted_message || ''; }
            } else {
              let extra = '';
              if (data.debug && data.debug.code_head) {
                extra = '\nCode head:\n' + data.debug.code_head;
                if (data.debug.lineno) {
                  extra += `\nAt line ${data.debug.lineno}, offset ${data.debug.offset || ''}`;
                }
              }
              if (err) { err.style.display = 'block'; err.textContent = (data.error || 'Extractor error') + extra; }
            }
          } catch (e) {
            if (err) { err.style.display = 'block'; err.textContent = 'Network error testing extractor'; }
          }
        });
      }
    })();
  </script>
{% endblock %}
